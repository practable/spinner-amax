#!/bin/bash
#example shellservice https://shell-access.practable.io
cd ../autogenerated

# we're relying on the video token files to find out what
# shell session we should make - we will name them similarly
# one year + 90 days (give long window after session stops working)
export SHELLTOKEN_LIFETIME=39312000
export SHELLTOKEN_ROLE=host
export SHELLTOKEN_SECRET=$(cat ~/secret/practable.pat)
export SHELLTOKEN_CONNECTIONTYPE=shell
export SHELLTOKEN_AUDIENCE=$1

# This one needs to change for each experiment
export SHELLTOKEN_TOPIC=123

DIR=.
filename='./(\w*).\w*.(\w*)'

for i in $DIR/video.access.*; do
	[[ $i =~ $filename ]]
	last="${BASH_REMATCH[2]}"
	out="shellhost2.service.${last}"
	export SHELLTOKEN_TOPIC="$last"
	export TOKEN=$(shellrelay token)
	export SESSION="${SHELLTOKEN_AUDIENCE}/${SHELLTOKEN_CONNECTIONTYPE}/${SHELLTOKEN_TOPIC}"
	mo ../services/shellhost2.service.mo > "$out"
	
done
