# rpi-spinnner-2.0
How to set up a Raspberry Pi to run a spinner 2.0 experiment. 

The process is fairly simple
0. Image an SD Card with RPI OS Lite and configure it to allow ssh
0. Connect up to RPI to power, network and a Nano IoT33 
0. Log in to check you have ssh access
1. Run a configure script on your admin machine
2. Run three ansible playbooks on your admin machine (which set things up on the rpi over ssh)
3. Reboot your RPI
3. Your experiment should be working

## Abbreviations

- BYOD - Bring Your Own Device
- OS - Operating System
- SBC - single board computer (Raspberry Pi, Odroid, etc)

## Formatting

### Trimming information

`<snip>` is used to denote that line(s) have been removed for clarity

```
something useful
<snip>
other useful stuff
```

#### repo location

`$this_repo` is used to indicate the root of the git repo for clarity in the documentation, and does not actually occur in any of the scripts.

### Indicating where to enter commands?

Code snippets will sometimes clarify which machine they should be run on, if it is not obvious from the context. E.g. your local admin machine:
```
# local
$ <some commands>
```

or on the raspberry pi (via the ssh connection you've established from your local machine). 

```
# rpi
$ <some command>
```



## Prequisites

### Hardware

This is our tested configuration. 

- Raspberry Pi 4 Model B 4 GB RAM 
- SD Card 32 GB, Class 10
- USB A to micro B cable for arduino
- Arduino Nano IOT33
- USB Webcam (Logitech C920)
- USB C power cable
- RJ45 Ethernet connection (avoid WiFi because it is laggy for users)
	
For assembling the full experiment, you will also need some additional items that are outside the scope of this repo:
- Spinner PCB including Infineon motor driver board
- Spinner hardware (stand, motor, encoder, disk)
- Experimental tray and 1/6th scale shipping container

### Software

The setup is best done from a linux machine. We have no plans to support commercial operating systems.

- Linux 
   - recommend Ubuntu 20.04 LTS
- Raspberry Pi Imager
   - [github](https://github.com/raspberrypi/rpi-imager) (see link in README for latest download location)
- Practable's [relay](https://github.com/practable/relay) 
    - ensure the `sessionrelay` and `shellrelay` commands are in your path 
- Ansible 
   - Tasks developed with v2.9.17 and python 3.7.4
   - [Installation](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)
   
### Information

You will need either access tokens or the access secret(s) to your relay(s). Your site administrator for practable will advise. These scripts are written for the case you have the secret. If you have been provided some tokens, you just copy them into `$this_repo/autogenerated` and skip some steps where indicated.

We assume that your relay access secret is the same for all the relays in use, and available at `~/secret/practable.pat`. That way, it's not in the repo.

### Network

You need a wired staging network where unknown devices can obtain an IP address via DHCP. Your admin machine is ideally also in the same subnet as your RPI. If you are at work/university, then you will need to create your own staging network because most institutional networks prevent unknown devices from accessing the wired networks. Without a staging network, you are are stuck in a catch-22 of not knowing enough about the device to get that permission for access to the production network (typically a BYOD network for devices that staff and students might bring in).

Good staging networks: your home network (no re-configuration is needed) or a linux laptop with a wifi connection and an RJ45 dongle (share the wifi to the dongle) - I use one for initial setups and the other for ad-hoc direct connections to experiments during field-testing.

### User environment

#### Mandatory

None listed

#### Optional

If you see `ap` in the commands here, it's due to my habitual usage of a zsh alias for `ansible-playbook`. You can set up the alias by adding this line to your Zsh configuration in `~/.zshrc`:

```
alias ap="ansible-playbook"
```

I'll aim to make all code-snippets here independent of that alias.



## Setup

Overview: The process starts by loading an OS onto an SD card, modifying it to permit `ssh` access, then finishing the setup over an ssh connection. There are a mixture of steps conducted on the SBC

### SBC OS

#### Base Image

Use the Raspberry Pi Imager to image your SD Card with `Raspberry Pi OS (other) ... Raspberry Pi OS Lite (32-bit)` 

Do not bother with the full version - the desktop features are not needed but use additional power.

You'll be asked to enter your sudo password and confirm the correct SD card location - best to remove other SD cards to avoid making a mistake and choosing your camera's SD card by accident.

After verifying the card is complete, it will be mounted on your system. Do not remove it from your reader yet, and leave it mounted for the next step.

#### Modifications

You should enable `ssh` - whilst the SD Card is still mounted on your computer, look for the book partition of the SD card in your file explorer.

Open the boot partition in a terminal, and create the file `ssh`

```
touch ssh
```

Exit the terminal, unmount/eject the `boot` and `rootfs` partitions, and remove the SD card from the reader.

### RPI OS

#### Find the IP address of your RPI

Before booting your RPI, you need to figure out the IP addresses of other devices on your network. In the next step, we will be looking for the IP address of the RPI, and it is easier if you already know which devices are NOT the RPI.

First, let's figure out the IP address of the wired ethernet port on your admin machine 
```
$ ip addr 
<snip>
3: enp0s31f6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether xx:xx:xx:xx:xx:xx brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.46/24 brd 192.168.0.255 scope global dynamic noprefixroute enp0s31f6
       valid_lft 784687sec preferred_lft 784687sec
    inet6 xxxx::xxxx:xxxx:xxxx:xxxx/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
<snip>
```
Our network card is at 192.168.0.46. The first three number groups matter here. Find all the devices on the same sub-net, using that IP address by set the last number group to `1/24` which is [shorthand](https://www.ietf.org/rfc/rfc1878.txt) for 0-254 (all possible IP in the subnet).
```
$ sudo nmap -sP 192.168.0.1/24
sudo nmap -sP 192.168.0.1/24
Starting Nmap 7.80 ( https://nmap.org ) at 2022-08-25 13:18 BST
Nmap scan report for _gateway (192.168.0.1)
Host is up (0.0016s latency).
MAC Address: xx:xx:xx:xx:xx:xx 
Nmap scan report for 192.168.0.29
Host is up (0.00059s latency).
MAC Address: xx:xx:xx:xx:xx:xx 
Nmap scan report for 192.168.0.52
Host is up (0.036s latency).
MAC Address: xx:xx:xx:xx:xx:xx 
Nmap scan report for 192.168.0.62
Host is up.
Nmap done: 256 IP addresses (3 hosts up) 
```

Put the SD card in your Raspberry Pi, connect the network cable, and power on. Wait about a minute (or repeat until a new device shows up)


```
$ sudo nmap -sP 192.168.0.1/24
sudo nmap -sP 192.168.0.1/24
Starting Nmap 7.80 ( https://nmap.org ) at 2022-08-25 13:18 BST
Nmap scan report for _gateway (192.168.0.1)
Host is up (0.0016s latency).
MAC Address: xx:xx:xx:xx:xx:xx 
Nmap scan report for 192.168.0.29
Host is up (0.00059s latency).
MAC Address: xx:xx:xx:xx:xx:xx 
Nmap scan report for 192.168.0.52
Host is up (0.036s latency).
MAC Address: xx:xx:xx:xx:xx:xx 
Nmap scan report for 192.168.0.62
Host is up.
MAC Address: yy:yy:yy:yy:yy:yy (Raspberry Pi Trading)
Nmap scan report for 192.168.0.184
Host is up (0.00027s latency).
Nmap done: 256 IP addresses (4 hosts up) 
```
Now you should see a new device that is labelled as a Raspberry Pi. If this step does not work, then the SD Card is corrupt, the network cable/power are disconnected, or the router on your network is not permitting DHCP requests from unknown devices.

In this case the IP address is 192.168.0.184.

Make a note of the MAC address of your SBC so that you can share that with your network administrators at the University - sometimes you must declare the MAC address to be able to access a wired BYOD network.

#### ssh into your RPI

The standard user and password on the image is usually `pi/raspberry`

On your machine, open a terminal
```
$ ssh pi@192.168.0.184 #change to whatever IP you found in previous step

The authenticity of host '192.168.0.184 (192.168.0.184)' can't be established.
ECDSA key fingerprint is SHA256:/0jZ9w8zL4h94rojSnSQ0Yewv5G8qK2AjCod/09pBkE.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '192.168.0.184' (ECDSA) to the list of known hosts.
pi@192.168.0.184's password: <--- enter the password here (usually, raspberry)

```
Then you should see something like this:

```
Linux raspberrypi 5.10.17-v7l+ #1414 SMP Fri Apr 30 13:20:47 BST 2021 armv7l

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.

SSH is enabled and the default password for the 'pi' user has not been changed.
This is a security risk - please login as the 'pi' user and type 'passwd' to set a new password.


Wi-Fi is currently blocked by rfkill.
Use raspi-config to set the country before use.

pi@raspberrypi:~ $ 
```

Change the password 

```
$ passwd
```

Ideally we would also set up ssh certificates but this is a future step.

You can now exit the session - we will do the next steps using ansible.

```
# rpi
$ exit
```

### SBC software and configuration

We need to generate some configuration files that are customised to your experiment. Your local admin for the practable system will advise on any naming conventions that apply at your site, as well as providing the relay key(s) which you need. 

This example is written for the case of configuring a single experiment (`spin32`) which genuinely, in this case, suffered a corrupted SD card after a successful semester of usage, and needs replacing with a fresh one).


#### Ansible hosts file

We need to let ansible know about this host.

```
sudo nano /etc/ansible/hosts
```
Add in a section like this (or modify an existing section if you have one)

```
<snip>
[rpispinnerv2]
spin32 ansible_host=192.168.0.184 practable_label=spin32

[rpispinnerv2:vars]
ansible_connection=ssh
ansible_user=pi
ansible_password=rtmptmp
<snip>
```



#### Practable connections

We need to configure routing and tokens for the video, data, shell, and shell2 connections. There are scripts provided to help you. They put files into `$this_repo./autogenerated`

Create the configuration files we need, assuming we are using the standard practable relay URLs.

```
#local
cd scripts
.configure spin 32 32 https://relay-access.practable.io https://shell-access.practable.io https://shell-access2.practable.io
```

##### Session

Now we can run our ansible playbooks - these each take some time, so get the kettle ready. It's nearly as fast doing multiple machines, because the playbooks are run in parallel. There is no need to do each RPI separately one after another.

```
#local
cd playbooks
ansible-playbook install-session
ansible-playbook install-shell
ansible-playbook install-firmware
```

If those commands go smoothly, then you are done with the install. If not, check out the troubleshooting guide below.

## Checking the installation

Go to the booking page link the adminstrator gave you, and you should be able to access/control the experiment. 

## Troubleshooting

If things are not working right, then you might be able to fix them by troubleshooting. 

### No DHCP

This is usually caused by 
- SD Card corrupt
- network administrator is unaware of the MAC address of the wired network port on the SBC

### No SSH connection

Since `sshd` is not enabled by default, you must enable it (see instructions) before incoming connections on port 22 will be accepted.

### Remote host identification has changed

If you work with a lot of experiments, sooner or later an old IP address on your staging network will be re-assigned to a new experiment you are setting up, and then you will see something like this:

```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
It is also possible that a host key has just been changed.
The fingerprint for the ECDSA key sent by the remote host is
SHA256:/0jZ9w8zL4h94rojSnSQ0Yewv5G8qK2AjCod/09pBkE.
Please contact your system administrator.
Add correct host key in /home/tim/.ssh/known_hosts to get rid of this message.
Offending ECDSA key in /home/tim/.ssh/known_hosts:178
  remove with:
  ssh-keygen -f "/home/tim/.ssh/known_hosts" -R "192.168.0.184"
ECDSA host key for 192.168.0.184 has changed and you have requested strict checking.
Host key verification failed.
```

Simply run the suggested command, and then carry on where you left off with trying to connect over `ssh`. The command is unique each time it happens (you're overwriting an entry in the known-hosts file so it must correspond to the host causing the problem _this_ time). E.g.

```
$ssh-keygen -f "/home/tim/.ssh/known_hosts" -R "192.168.0.184"

# Host 192.168.0.184 found: line 178
/home/tim/.ssh/known_hosts updated.
Original contents retained as /home/tim/.ssh/known_hosts.old
```

### Check the OS
If you're not sure if you have the right OS for the ansible scripts, you can check. For this experiment, you should see something like this

```
$ uname -a
Linux raspberrypi 5.10.17-v7l+ #1414 SMP Fri Apr 30 13:20:47 BST 2021 armv7l GNU/Linux
```

### Ansible cannot reach rpi

If you are having trouble connecting via ansible, following the guidance on verbose logging [here](https://docs.ansible.com/ansible/latest/network/user_guide/network_debug_troubleshooting.html)

You might find you've got the format of the /etc/ansible/hosts incorrect (e.g. didn't name the vars section correctly, got the password wrong etc).


### ttyACM0 Device not found 

If you get this error, reboot the raspberry pi and try again. If the error persists, check which device name it has been assigned (`/dev/ttyACM0` is expected for Nano 33 IOT)
```
#rpi
lsusb
dmesg | tail
```

